#!/bin/sh

set -eu

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/.."

(
  set -eu

  cd "$DIR"

  source .envrc

  name=boshua
  version=0.0.0+dev
  commit=$( git rev-parse HEAD | cut -c-10 )$( git diff-index --quiet HEAD -- || echo "+dirty" )
  built=$( date -u +%Y-%m-%dT%H:%M:%S+00:00 )

  go build \
    -ldflags "
      -X github.com/dpb587/boshua/cli/app.name=$name \
      -X github.com/dpb587/boshua/cli/app.semver=$version \
      -X github.com/dpb587/boshua/cli/app.commit=$commit \
      -X github.com/dpb587/boshua/cli/app.built=$built \
      -X main.defaultServer=${BOSHUA_SERVER:-}
    " \
    -o tmp/boshua \
    main/boshua/boshua.go
)

exec $DIR/tmp/boshua "$@"
